#!/usr/bin/env bash
#-*-shell-script-*-

port=3000
if [ -n "$1" ]
then
    port=$1
fi

fail() {
    echo "$@" 1>&2
    exit 1
}

pid_file="tmp/pids/server.pid"
if [ -f tmp/pids/server.pid ]
then
    kill -9 "$(cat "$pid_file")" || fail "Error killing PID in '$pid_file'"
    sleep 1
fi

bundle install \
    && for n in test development ; do bin/rake db:migrate RAILS_ENV=$n ; done
if [ "$?" -ne 0 ]
then
    fail "Error setting up rails env"
fi

rails s -b 0.0.0.0 -p "$port"
