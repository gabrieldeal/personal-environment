#!/usr/bin/env bash
#-*-shell-script-*-

# Because I am a bad person.

port=3000
if [ -n "$1" ]
then
    port=$1
fi

fail() {
    echo "$@" 1>&2
    exit 1
}

development_file=config/environments/development.rb
temp_development_file=/tmp/$USER-development.rb

ping_app=curl
if ! which $ping_app >/dev/null 2>&1
then
   fail "ERROR: Missing $ping_app"
fi

test -f tmp/pids/server.pid \
    && kill "$(cat tmp/pids/server.pid)" \
    && sleep 1

if ! test -f $development_file
then
   fail "Missing $development_file"
fi

# Turn on job control for 'fg':
set -m

cp "$development_file" "$temp_development_file" \
    && sed 's/Bullet.raise = true/Bullet.raise = false/;' "$temp_development_file" >"$development_file" \
    && bundle install \
    && for n in test development ; do bin/rake db:migrate RAILS_ENV=$n ; done
if [ "$?" -ne 0 ]
then
    fail "Error setting up rails env"
fi

rails s -b 0.0.0.0 -p "$port" &

# Wait for the webserver to start before undoing the development.rb changes:
while ! $ping_app "http://0.0.0.0:$port" >/dev/null 2>&1
do
    sleep 1 || exit 1
    echo Pinging the webserver...
done

cp "$temp_development_file" "$development_file" \
    && rm "$temp_development_file"

fg
