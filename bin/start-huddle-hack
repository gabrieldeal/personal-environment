#!/usr/bin/env bash
#-*-shell-script-*-

set-xterm-title "OSS huddle rails server"

port=443
if [ -n "$1" ]
then
    port=$1
fi

fail() {
    echo "$@" 1>&2
    exit 1
}

pid_file="tmp/pids/server.pid"
if [ -f tmp/pids/server.pid ]
then
    kill -9 "$(cat "$pid_file")" || fail "Error killing PID in '$pid_file'"
    sleep 1
fi

# In case we are not ran via an interactive shell:
source "/usr/share/rvm/scripts/rvm"

## Can only run this as root:
#    && rvm get stable \

cd ~/projects/oss/huddle \
    && rvm install `cat .ruby-version` \
    && rvm use `cat .ruby-version`@`cat .ruby-gemset` --create \
    && gem install mailcatcher \
    && gem install bundle \
    && bundle install \
    && echo "Migrating development..." && bin/rake db:migrate RAILS_ENV=development \
    && echo "Migrating test..." && bin/rake db:migrate RAILS_ENV=test
if [ "$?" -ne 0 ]
then
    fail "Error setting up rails env"
fi

#source "$(dirname "$0")/export-webpack-dev-server-settings" \
#    &&

# Use Unicorn in hopes that it will freeze less than Puma.
#gem install unicorn && unicorn -l "0.0.0.0:$port"
#RAILS_ENV=development bin/rails s -b 0.0.0.0 -p "$port"

# Disabled SSL because it messes with Webpack Dev Server's auto-reloading.
#
# Setting up SSL https://gist.github.com/tadast/9932075
#
# sudo touch /etc/authbind/byport/443
# sudo chmod 777 /etc/authbind/byport/443
authbind --deep bin/rails s -b "ssl://0.0.0.0:$port?key=$HOME/.ssh/server.key&cert=$HOME/.ssh/server.crt"
