#!/usr/bin/env bash
#-*-shell-script-*-

set-xterm-title "OSS huddle rails server"

port=3000
if [ -n "$1" ]
then
    port=$1
fi

fail() {
    echo "$@" 1>&2
    exit 1
}

pid_file="tmp/pids/server.pid"
if [ -f tmp/pids/server.pid ]
then
    kill -9 "$(cat "$pid_file")" || fail "Error killing PID in '$pid_file'"
    sleep 1
fi

rvm get stable \
    && rvm use `cat .ruby-version`@`cat .ruby-gemset` --create \
    && rvm install `cat .ruby-version` \
    && gem install mailcatcher \
    && gem install bundle \
    && bundle install \
    && echo "Migrating test..." && bin/rake db:migrate RAILS_ENV=test \
    && echo "Migrating development..." && bin/rake db:migrate RAILS_ENV=development
if [ "$?" -ne 0 ]
then
    fail "Error setting up rails env"
fi

rails s -b 0.0.0.0 -p "$port"
