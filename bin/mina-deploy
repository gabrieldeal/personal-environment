#!/usr/bin/env sh

fail() {
    echo "$@" 1>&2
    exit 1
}

usage="Usage: $0 BRANCH SERVER"

branch="$1"
test -z "$branch" && fail "$usage"
server="$2"
test -z "$server" && fail "$usage"

dir=~/projects/oss/huddle2
cd "$dir" \
    && git fetch -p \
    && git checkout "$branch" \
    && git pull origin "$branch" \
    || fail "Might need to do: cd $dir && git merge --abort && git checkout master && git branch -D '$branch'"

rm -rf node_modules \
    && yarn install \
    && bundle exec mina full_deploy HOST="$server.ossd.co" BRANCH="$branch"
exit $?
