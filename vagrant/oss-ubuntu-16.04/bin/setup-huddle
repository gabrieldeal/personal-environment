#!/bin/bash
# -*- shell-script -*-

DIR=~/projects/oss/huddle
if [ -n "$1" ]
then
    DIR="$1"
fi

mkdir -p $DIR \
    && cd $DIR \
    && (test -d .git || git clone git@github.com:officespacesoftware/huddle.git .) \
    && . /usr/local/rvm/scripts/rvm \
    && rvm alias create huddle `cat .ruby-version`@`cat .ruby-gemset` --create \
    && rvm install `cat .ruby-version` \
    && rvm huddle do gem install bundle \
    && rvm huddle do bundle install \
    && rvm huddle do gem install mailcatcher \
    && sed 's/root/vagrant/; s/officespace$/officespace_development/; s/password:/password: ""/' config/database.yml.example >config/database.yml \
    && cp config/application.yml.example config/application.yml \
    && sed -i -e 's/`root`/`vagrant`/g' db/structure.sql \
    && for n in test development ; do mysql officespace_$n < db/structure.sql && rvm huddle do rake db:migrate RAILS_ENV=$n; done \
    && npm install \
    && echo -e "\nSuccess!"
